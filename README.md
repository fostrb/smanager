# SManager
Simple remote service manager

SManager is a persistent service that spawns other services and provides limited remote access to them via a list of predefined commands.

To start SManager:

```bash
python smanager.py
```
Connect to SManager over TCP via telnet or provided tshell.py to interact and issue commands.


    >telnet <smanager_address> 10000
    Trying 127.0.0.1...
    Connected to localhost.
    Escape character is '^]'.
    **************************************************
    Service Manager
    **************************************************
    Available Services:
    -systemstatus
    --------------------------------------------------

# Services

SManager services are implementations of the SService class, which provides the following features:

Methods within the class beginning with "cmd_" are recognized as remote-accessible commands.
```python
import os
def cmd_uptime(self):
    '''Returns uptime of system'''
    return os.popen('uptime').read()
```
    
These commands can be run by connecting to SManager and issuing:

```bash
"<service_name> <command_name> <command_args>"
```

Example:

    >systemstatus uptime
     12:20:43 up 12 days, 14:36,  6 users,  load average: 0.28, 0.39, 0.46
    --------------------------------------------------

Methods beginning with "toplevel_cmd_" do not require service name context.
```python
import os
def toplevel_cmd_hostname(self):
    '''Returns hostname of system'''
    return os.popen('hostname').read()
```


    >hostname
    mycomputerhostname
    --------------------------------------------------

# The help command
The 'help' command can be run with or without service name context.
Running 'help' without context will display the available services and default+toplevel commands

    >help
    --------------------------------------------------
    SManager
    --------------------------------------------------
    Toplevel exposed commands:
        hostname: Returns hostname of system
    --------------------------------------------------
    Services:
        systemstatus: Simple example SService implementation
    Commands:
        help: display help message
        kill: kill server
        restart: restart services

    --------------------------------------------------


Running '<servicename> help' or 'help <servicename>' will display commands related to that service.

    >systemstatus help
    ----------------------------------------
    SystemStatus
    Simple example SService implementation
    ----------------------------------------
    help: Print the help dialogue for this service
    uptime: Returns uptime of system
    hostname: Returns hostname of system

    --------------------------------------------------

Help dialogues are automatically generated by the docstrings of methods and classes.

# Automating tasks with SManager

Making a connection to SManager and issuing a command via a script or other system is simple.

```bash
echo -n 'systemstatus uptime' | nc <smanager_host> 10000
```

The help command optionally accepts the '-s' switch, simplifying output for parsing by code with knowledge of the system.

    >help -s
    TOP: captest capture_at scrapfreq startcap stopcap hostname
    SERVICES: scrapman systemstatus
    COMMANDS: help kill restart

For example, a script might want to see if 'scrapman' was an available service before attempting to issue commands.

```python
from demo_script import smanager_cmd, address, port
import time

logfile = '/tmp/useful_log.log'

try:
    # Connect to smanager and ask for simplified help summary
    help_output = smanager_cmd(address, port, 'help -s')
except:
    with open(logfile) as fp:
        fp.write("Couldn't connect to smanager at " + str(time.time()))

for line in help_output.split('\n'):
    if line.startswith('SERVICES:'):
        if 'scrapman' in line:
            # if scrapman exists as a service, get its heartbeat and log it
            heartbeat = smanager_cmd('scrapman get_heartbeat')
            with open(logfile) as fp:
                fp.write("Scrapman heartbeat at " + str(time.time()) + ':' + str(heartbeat) + '\n')
        else:
            # if scrapman doesn't exist as a service, log that
            with open(logfile) as fp:
                fp.write("Scrapman not available at " + str(time.time()) + '\n')
```


